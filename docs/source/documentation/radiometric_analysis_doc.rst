.. _quality_ra:

Radiometric Analysis
====================

Radiometric analysis can be used to assess and verify product quality globally on images with homogeneous distributed targets.

This analysis has been implemented with two main algorithms: block-wise analysis and point-wise analysis.

The former is used to extract **Radiometric Profiles** from the input SAR image corresponding to azimuth blocks obtained by
partitioning the whole scene, while the latter can extract averaged profiles around a specific point in the scene.
The first algorithm should be the preferred one and it's the one detailed in this documentation.

Block-wise Radiometric Analysis
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Using this algorithm the whole scene is automatically analyzed after being subdivided in azimuth blocks spanning a given
amount of azimuth lines in a direction and the whole slant range axis in the other (except near and far range values removed using a margin).
In case of TopSAR/ScanSAR acquisitions, bursts are used as default azimuth blocks.

.. note::

    Blocks dimension can be changed using the configuration file:

    | **azimuth_block_size**: size of block in terms of azimuth lines (pixels) for acquisitions without bursts
    | **range_pixel_margin**: near/far range margin removed from axis

Once the image is partitioned, each block is analyzed and a radiometric profiles is extracted. Pre-implemented outlier removal
algorithms and smoothening filters can be applied to the block values if needed using the `radiometric_profiles.profile_parameters`
configuration sections.

Image can be provided in any radiometric quantity provided that it's specified in the configuration file if different from
the default beta-nought. Output quantity can also be selected as an argument of the ``radiometric_profiles`` function.

Output data, both numeric and graphical, can be used to verify and check data properties such as: expected profiles trends
with respect to incidence angle, noise magnitude and azimuth trends.

For profiles extracted along the *RANGE* direction, the incidence angle axis is computed using direct geocoding, while for
*AZIMUTH* profiles a relative time axis in seconds is returned.

Few pre-configured radiometric profiles have already been developed and implemented in this module, namely:

- **Noise Equivalent Sigma-Zero (NESZ) Profiles**
- **Gamma-Zero Profiles**
- **Scalloping Profiles**

These are all wrapper on the same generic radiometric profile core function with arguments and key parameters pre-set to perform
that specific task.

Image Pre-Processing
~~~~~~~~~~~~~~~~~~~~

The pre-processing algorithm applied when using the ``radiometric_profiles`` function or any other accessible pre-configured function
available in the ``radiometric_analysis.block_wise_analysis`` module is the same.

It consists in partitioning the whole scene in azimuth blocks using actual bursts if any, or by dividing the azimuth axis
by the provided number of lines per blocks. The representation output axis is then computed accordingly to the profile direction.

Then, for each block, data is read from the raster file, converted to intensity values (square of the absolute pixel values)
and it the radiometric quantity is converted to the selected output one, if needed.
The profile extraction algorithm can thus be applied to the data block.

This procedure is applied to each channel of the input product.

NESZ Profiles
~~~~~~~~~~~~~

NESZ profiles are extracted along the **RANGE** direction, one for each azimuth partitioning block. The output radiometric
quantity is set to sigma-nought.

Low backscatter areas can be exploited for this measurement in order to assess the noise level in the image. The NESZ level
thus obtained from SLC data can then be compared with the NESZ maps if generated by the processor or, in general, with the
expected noise level.
The NESZ level estimation is typically performed for cross-pol channels only since signal level in co-pol channels is always too high.

The profile extraction algorithm for NESZ is already implemented and it consists in performing a 2D average of the valid
block data (not null values) and then extracting only the first percentile of azimuth distributed data in the block for each
range pixel.


Gamma-Zero (:math:`\gamma^0`) Profiles
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Gamma-Zero profiles are extracted along the **RANGE** direction, one for each azimuth partitioning block. The output radiometric
quantity is set to gamma-nought.

These :math:`\gamma^0` profiles can be exploited to assess relative radiometric calibration in case of ScanSAR and TopSAR modes by comparing
the average levels from beam to beam. They can also be used in conjunction with the antenna pattern to estimate the
residual roll correction.

The profile extraction algorithm for :math:`\gamma^0` is already implemented and it consists in extracting the mean of
azimuth distributed data in the block for each range pixel after applying a median filter and performing outlier removal.
The filter and the outlier removal functionalities can be enabled/disabled and their parameters edited from the configuration
file.


Scalloping Profiles
~~~~~~~~~~~~~~~~~~~

Scalloping profiles are extracted along the **AZIMUTH** direction, one for each azimuth partitioning block. The output radiometric
quantity is set to gamma-nought.

Scalloping is a characteristic of ScanSAR and TopSAR due to the azimuth elementary pattern of each TRM introducing additional
gain factor on the squinted beams. This gain is compensated during the processing exploiting a model of the azimuth elementary
pattern. After scalloping compensation, each burst is expected to be flat in the azimuth direction.

These profiles can be used to assess the residual scalloping and thus a remarkable non-flat trend could be related to errors
in the processing compensation.

The profile extraction algorithm for scalloping is already implemented and it consists in extracting the residual profile
values along azimuth direction for each block relative to the profile mean value itself.
Outlier removal can be enabled/disabled and its parameters changed from the configuration file.


Custom Radiometric Profiles
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Using the core ``radiometric_profiles`` function a custom radiometric profile can be configured to match the needs of the user.
Input/output radiometric quantities conversion and profile direction can be set using the configuration file or setting the
input arguments, while the profile extraction algorithm can be developed and provided as input to the main function to be
applied just after the pre-processing algorithm section.


Analysis Output
^^^^^^^^^^^^^^^

Output data are exported in lists of custom ``RadiometricProfilesOutput`` dataclasses containing the profiles for each channel in the input product.
Each dataclass contains the profiles, the output axis and the 2D histogram of each azimuth block analyzed for that channel.

These dataclasses can then be passed as arguments to the ``support.radiometric_profiles_to_netcdf`` functionality to dump a netCDF 4
file containing all the results and/or to the ``graphical_output.radiometric_2D_hist_plot`` to generate the 2D histogram plot.

.. note::

    Graphical output functionalities are available only if the package has been installed with the [graphs] optional
    dependencies. Refer to the :ref:`installation documentation<quality_install>` for more information.
